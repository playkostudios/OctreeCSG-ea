var pr=Math.pow;var Re=(s,r,e)=>new Promise((t,o)=>{var n=c=>{try{i(e.next(c))}catch(l){o(l)}},a=c=>{try{i(e.throw(c))}catch(l){o(l)}},i=c=>c.done?t(c.value):Promise.resolve(c.value).then(n,a);i((e=e.apply(s,r)).next())});var hr=(t=>(t[t.WorkerCreationFailure=0]="WorkerCreationFailure",t[t.OperationFailure=1]="OperationFailure",t[t.DecodeFailure=2]="DecodeFailure",t))(hr||{}),te=class extends Error{constructor(e,t){let o;switch(e){case 0:o="Job failed (worker creation failed)";break;case 1:o="Job failed (operation exception)";break;default:o="Job failed (decode failure)"}super(`${o}: ${t}`);this.failReason=e;this.originalError=t}static WorkerCreationFailure(e){return new te(0,""+e)}static OperationFailure(e){return new te(1,""+e)}static DecodeFailure(e){return new te(2,""+e)}};var Ie=.3333333333333333,Q=Math.PI*2,dr=Math.PI/2;import{mat3 as wt,vec3 as J}from"gl-matrix";var xe=J.create(),Pe=J.create(),we=J.create(),qe=J.create(),Ct=[J.fromValues(1e-5,0,0),J.fromValues(0,1e-5,0),J.fromValues(0,0,1e-5),J.fromValues(-1e-5,0,0),J.fromValues(0,-1e-5,0),J.fromValues(0,0,-1e-5)],yr=wt.create(),ro=4*Math.PI;function Pt(s,r){return s.slice(r,r+3)}function br(s,r){let e=0,t=s.length;for(let o=0;o<t;o+=9){J.sub(xe,Pt(s,o),r),J.sub(Pe,Pt(s,o+3),r),J.sub(we,Pt(s,o+6),r);let n=J.length(xe),a=J.length(Pe),i=J.length(we);wt.set(yr,xe[0],Pe[0],we[0],xe[1],Pe[1],we[1],xe[2],Pe[2],we[2]),e+=2*Math.atan2(wt.determinant(yr),n*a*i+J.dot(xe,Pe)*i+J.dot(Pe,we)*n+J.dot(xe,we)*a)}return Math.round(e/ro)}function gr(s,r,e){if(J.copy(qe,r),br(s,qe)!==0)return!0;if(e){for(let t of Ct)if(J.add(qe,r,t),br(s,qe)!==0)return!0}return!1}function ze(s){let r=new Float32Array(s.length*3*3),e=0;for(let t of s){let o=t.triangle;r.set(o.a,e),e+=3,r.set(o.b,e),e+=3,r.set(o.c,e),e+=3}return r}function oo(s){let r=new Float32Array(s.length*3*3),e=0;for(let t of s)r.set(t.vertices[0].normal,e),e+=3,r.set(t.vertices[1].normal,e),e+=3,r.set(t.vertices[2].normal,e),e+=3;return r}function St(s,r){let e=s.getPolygons(),t=ze(e);r.push(t.buffer);let o=oo(e);return r.push(o.buffer),[t,o]}import{vec2 as Ee,vec3 as p}from"gl-matrix";var P=p.create(),G=p.create(),Ne=p.create();function no(s,r,e={coplanar:!1,source:p.create(),target:p.create()}){let t=e,o=s.a,n=s.b,a=s.c,i=r.a,c=r.b,l=r.c;p.sub(P,i,l),p.sub(G,c,l);let u=p.cross(p.create(),P,G);p.sub(P,o,l);let m=p.dot(P,u);p.sub(P,n,l);let f=p.dot(P,u);p.sub(P,a,l);let h=p.dot(P,u);if(m*f>0&&m*h>0)return!1;p.sub(P,n,o),p.sub(G,a,o);let y=p.cross(p.create(),P,G);p.sub(P,i,a);let b=p.dot(P,y);p.sub(P,c,a);let d=p.dot(P,y);p.sub(P,l,a);let v=p.dot(P,y);return b*d>0&&b*v>0?!1:(t.N2=u,t.N1=y,m>0?f>0?ne(a,o,n,i,l,c,b,v,d,t):h>0?ne(n,a,o,i,l,c,b,v,d,t):ne(o,n,a,i,c,l,b,d,v,t):m<0?f<0?ne(a,o,n,i,c,l,b,d,v,t):h<0?ne(n,a,o,i,c,l,b,d,v,t):ne(o,n,a,i,l,c,b,v,d,t):f<0?h>=0?ne(n,a,o,i,l,c,b,v,d,t):ne(o,n,a,i,c,l,b,d,v,t):f>0?h>0?ne(o,n,a,i,l,c,b,v,d,t):ne(n,a,o,i,c,l,b,d,v,t):h>0?ne(a,o,n,i,c,l,b,d,v,t):h<0?ne(a,o,n,i,l,c,b,v,d,t):(t.coplanar=!0,xr(o,n,a,i,c,l,y)))}function ne(s,r,e,t,o,n,a,i,c,l){return a>0?i>0?se(s,e,r,n,t,o,l):c>0?se(s,e,r,o,n,t,l):se(s,r,e,t,o,n,l):a<0?i<0?se(s,r,e,n,t,o,l):c<0?se(s,r,e,o,n,t,l):se(s,e,r,t,o,n,l):i<0?c>=0?se(s,e,r,o,n,t,l):se(s,r,e,t,o,n,l):i>0?c>0?se(s,e,r,t,o,n,l):se(s,r,e,o,n,t,l):c>0?se(s,r,e,n,t,o,l):c<0?se(s,e,r,n,t,o,l):(l.coplanar=!0,xr(s,r,e,t,o,n,l.N1))}function xr(s,r,e,t,o,n,a){let i=Ee.create(),c=Ee.create(),l=Ee.create(),u=Ee.create(),m=Ee.create(),f=Ee.create(),h=a[0]<0?-a[0]:a[0],y=a[1]<0?-a[1]:a[1],b=a[2]<0?-a[2]:a[2];return h>b&&h>=y?(i[0]=r[2],i[1]=r[1],c[0]=s[2],c[1]=s[1],l[0]=e[2],l[1]=e[1],u[0]=o[2],u[1]=o[1],m[0]=t[2],m[1]=t[1],f[0]=n[2],f[1]=n[1]):y>b&&y>=h?(i[0]=r[0],i[1]=r[2],c[0]=s[0],c[1]=s[2],l[0]=e[0],l[1]=e[2],u[0]=o[0],u[1]=o[2],m[0]=t[0],m[1]=t[2],f[0]=n[0],f[1]=n[2]):(i[0]=s[0],i[1]=s[1],c[0]=r[0],c[1]=r[1],l[0]=e[0],l[1]=e[1],u[0]=t[0],u[1]=t[1],m[0]=o[0],m[1]=o[1],f[0]=n[0],f[1]=n[1]),so(i,c,l,u,m,f)}function so(s,r,e,t,o,n){return k(s,r,e)<0?k(t,o,n)<0?et(s,e,r,t,n,o):et(s,e,r,t,o,n):k(t,o,n)<0?et(s,r,e,t,n,o):et(s,r,e,t,o,n)}function k(s,r,e){return(s[0]-e[0])*(r[1]-e[1])-(s[1]-e[1])*(r[0]-e[1])}function et(s,r,e,t,o,n){return k(t,o,s)>=0?k(o,n,s)>=0?k(n,t,s)>=0?!0:At(s,r,e,t,n):k(n,t,s)>=0?At(s,r,e,n,o):Ot(s,r,e,t,o,n):k(o,n,s)>=0?k(n,t,s)>=0?At(s,r,n,o,t):Ot(s,r,e,o,n,t):Ot(s,r,e,n,t,o)}function At(s,r,e,t,o){if(k(o,t,r)>=0){if(k(s,t,r)>=0)return k(s,r,o)>=0;if(k(r,e,t)>=0)return k(e,s,t)>=0}else if(k(o,t,e)>=0&&k(s,t,e)>=0)return k(s,e,o)>=0||k(r,e,o)>=0;return!1}function Ot(s,r,e,t,o,n){if(k(n,t,r)>=0){if(k(n,o,r)<=0){if(k(s,t,r)>0)return k(s,o,r)<=0;if(k(s,t,e)>=0)return k(r,e,t)>=0}else if(k(s,o,r)<=0&&k(n,o,e)<=0)return k(r,e,o)>=0}else if(k(n,t,e)>=0){if(k(r,e,n)>=0)return k(s,t,e)>=0;if(k(r,e,o)>=0)return k(n,e,o)>=0}return!1}function se(s,r,e,t,o,n,a){let i;p.sub(P,r,s),p.sub(G,n,s);let c=p.cross(p.create(),P,G);if(p.sub(Ne,t,s),p.dot(Ne,c)>0){if(p.sub(P,e,s),p.cross(c,P,G),p.dot(Ne,c)<=0)return p.sub(G,o,s),p.cross(c,P,G),p.dot(Ne,c)>0?(p.sub(P,s,t),p.sub(G,s,e),i=p.dot(P,a.N2)/p.dot(G,a.N2),p.scale(P,G,i),p.sub(a.source,s,P),p.sub(P,t,s),p.sub(G,t,n),i=p.dot(P,a.N1)/p.dot(G,a.N1),p.scale(P,G,i),p.sub(a.target,t,P)):(p.sub(P,t,s),p.sub(G,t,o),i=p.dot(P,a.N1)/p.dot(G,a.N1),p.scale(P,G,i),p.sub(a.source,t,P),p.sub(P,t,s),p.sub(G,t,n),i=p.dot(P,a.N1)/p.dot(G,a.N1),p.scale(P,G,i),p.sub(a.target,t,P)),!0}else if(p.sub(G,o,s),p.cross(c,P,G),p.dot(Ne,c)>=0)return p.sub(P,e,s),p.cross(c,P,G),p.dot(Ne,c)>=0?(p.sub(P,s,t),p.sub(G,s,e),i=p.dot(P,a.N2)/p.dot(G,a.N2),p.scale(P,G,i),p.sub(a.source,s,P),p.sub(P,s,t),p.sub(G,s,r),i=p.dot(P,a.N2)/p.dot(G,a.N2),p.scale(P,G,i),p.sub(a.target,s,P)):(p.sub(P,t,s),p.sub(G,t,o),i=p.dot(P,a.N1)/p.dot(G,a.N1),p.scale(P,G,i),p.sub(a.source,t,P),p.sub(P,s,t),p.sub(G,s,r),i=p.dot(P,a.N2)/p.dot(G,a.N2),p.scale(P,G,i),p.sub(a.target,s,P)),!0;return!1}function ao(s,r,e){let t=p.sub(p.create(),s.end,s.start),o=p.sub(p.create(),r.end,r.start),n=p.sub(p.create(),s.start,r.start),a=p.dot(n,t),i=p.dot(n,o),c=p.dot(t,o),l=p.dot(t,t),u=p.dot(o,o),m=l*u-c*c,h=(i*c-a*u)/m,y=(i+h*c)/u,b=p.scaleAndAdd(t,s.start,t,h),d=p.scaleAndAdd(o,r.start,o,y),v=!1,C=!1;return 0<=h&&h<=1&&0<=y&&y<=1&&(v=!0),p.distance(b,d)<=1e-5&&(C=!0),C&&v?(e&&e.push(b,d),!0):!1}function vr(s){return[{start:s.a,end:s.b},{start:s.b,end:s.c},{start:s.c,end:s.a}]}function Pr(s,r,e={coplanar:!1,source:p.create(),target:p.create()}){let t=no(s,r,e);if(!t&&e.coplanar){let o=vr(s),n=vr(r);for(let a=0;a<3;a++)for(let i=0;i<3;i++)if(ao(o[a],n[i]))return!0;return!1}return t}import{vec3 as pe}from"gl-matrix";var Me=class{constructor(r,e,t){this.a=r;this.b=e;this.c=t}static copyAuxValues(r,e){r._midpoint&&(e._midpoint?pe.copy(e._midpoint,r._midpoint):e._midpoint=pe.clone(r._midpoint)),r._hash&&(e._hash=r._hash)}set(r,e,t){this.a=r,this.b=e,this.c=t,this._midpoint=void 0,this._hash=void 0}get midpoint(){return this._midpoint?this._midpoint:(this._midpoint=pe.clone(this.a),pe.add(this._midpoint,this._midpoint,this.b),pe.add(this._midpoint,this._midpoint,this.c),pe.scale(this._midpoint,this._midpoint,Ie))}equals(r){return pe.equals(this.a,r.a)&&pe.equals(this.b,r.b)&&pe.equals(this.c,r.c)}murmur_32_scramble(r){return r*=3432918353,r=r<<15|r>>17,r*=461845907,r&4294967295}murmur3_32(r,e){let t=e,o=new Uint32Array(r.buffer);for(let n of o)t^=this.murmur_32_scramble(n),t=t<<13&4294967295|t>>19,t=t*5+3864292196&4294967295;return t^=o.byteLength,t^=t>>16,t=t*2246822507&4294967295,t^=t>>13,t=t*3266489909&4294967295,t^=t>>16,t}get hash(){if(this._hash!==void 0)return this._hash;let r=new Float32Array([this.a[0]*1e5,this.a[1]*1e5,this.a[2]*1e5,this.b[0]*1e5,this.b[1]*1e5,this.b[2]*1e5,this.c[0]*1e5,this.c[1]*1e5,this.c[2]*1e5]);return this._hash=this.murmur3_32(r,3935228948),this._hash}};import{mat3 as io,mat4 as wr,quat as co,vec2 as Cr,vec3 as Gt}from"gl-matrix";var O=Gt.create(),$=Gt.create(),Vt=Gt.create(),tt=io.create(),$e=wr.create(),kt=wr.create(),Sr=Cr.create(),Ar=Cr.create(),rt=co.create();import{vec3 as de,vec4 as Rt}from"gl-matrix";var W=class{constructor(r){this.buffer=r}static fromNormal(r,e){let t=Rt.create();return de.copy(t,r),t[3]=e,new W(t)}get w(){return this.buffer[3]}set w(r){this.buffer[3]=r}get unsafeNormal(){return this.buffer}clone(){return new W(Rt.clone(this.buffer))}flip(){de.negate(this.buffer,this.buffer),this.w=-this.w}delete(){this.buffer=void 0}equals(r){return Rt.equals(this.buffer,r.buffer)}static calculateNormal(r,e,t){return de.sub(O,e,r),de.sub($,t,r),de.cross(O,O,$),de.normalize(O,O),de.clone(O)}static fromPoints(r,e,t){let o=W.calculateNormal(r,e,t);return W.fromNormal(o,de.dot(o,r))}};import{mat3 as lo,vec3 as Or}from"gl-matrix";var uo=0;var D=class{constructor(r,e){this.intersects=!1;this.state=0;this.previousState=0;this.previousStates=[];this.valid=!0;this.coplanar=!1;this.originalValid=!1;this.newPolygon=!1;this.id=uo++,this.vertices=r.map(t=>t.clone()),this.shared=e,this.plane=W.fromPoints(this.vertices[0].pos,this.vertices[1].pos,this.vertices[2].pos),this.triangle=new Me(this.vertices[0].pos,this.vertices[1].pos,this.vertices[2].pos)}get midpoint(){return this.triangle.midpoint}applyMatrix(r,e){let t=e||lo.normalFromMat4(tt,r);this.vertices.forEach(o=>{Or.transformMat4(o.pos,o.pos,r),Or.transformMat3(o.normal,o.normal,t)}),this.plane.delete(),this.plane=W.fromPoints(this.vertices[0].pos,this.vertices[1].pos,this.vertices[2].pos),this.triangle.set(this.vertices[0].pos,this.vertices[1].pos,this.vertices[2].pos)}reset(r=!0){this.intersects=!1,this.state=0,this.previousState=0,this.previousStates.length=0,this.valid=!0,this.coplanar=!1,r&&(this.originalValid=!1),this.newPolygon=!1}setState(r,e){this.state!==e&&(this.previousState=this.state,this.state!==0&&this.previousStates.push(this.state),this.state=r)}checkAllStates(r){if(this.state!==r||this.previousState!==r&&this.previousState!==0)return!1;for(let e of this.previousStates)if(e!==r)return!1;return!0}setInvalid(){this.valid=!1}setValid(){this.valid=!0}clone(){let r=new D(this.vertices.map(e=>e.clone()),this.shared);return r.intersects=this.intersects,r.valid=this.valid,r.coplanar=this.coplanar,r.state=this.state,r.originalValid=this.originalValid,r.newPolygon=this.newPolygon,r.previousState=this.previousState,r.previousStates=this.previousStates.slice(),Me.copyAuxValues(this.triangle,r.triangle),r}flip(){this.vertices.reverse().forEach(e=>e.flip());let r=this.triangle.a;this.triangle.a=this.triangle.c,this.triangle.c=r,this.plane.flip()}delete(){this.vertices.forEach(r=>r.delete()),this.vertices.length=0,this.plane&&(this.plane.delete(),this.plane=void 0),this.triangle=void 0,this.shared=void 0,this.setInvalid()}};import{vec3 as Ce}from"gl-matrix";var re=(n=>(n[n.Undecided=0]="Undecided",n[n.Back=void 0]="Back",n[n.Front=void 0]="Front",n[n.CoplanarBack=3]="CoplanarBack",n[n.CoplanarFront=4]="CoplanarFront",n))(re||{}),Gr=0,It=1,ot=2,Vr=3;function Ir(s,r,e=[]){let t={polygon:s,type:re.Undecided},o=0,n=[];for(let a of s.vertices){let i=Ce.dot(r.unsafeNormal,a.pos)-r.w,c=i<-1e-5?ot:i>1e-5?It:Gr;o|=c,n.push(c)}switch(o){case Gr:t.type=Ce.dot(r.unsafeNormal,s.plane.unsafeNormal)>0?re.CoplanarFront:re.CoplanarBack,e.push(t);break;case It:t.type=re.Front,e.push(t);break;case ot:t.type=re.Back,e.push(t);break;case Vr:{let a=[],i=[],c=s.vertices.length;for(let l=0;l<c;l++){let u=(l+1)%c,m=n[l],f=n[u],h=s.vertices[l],y=s.vertices[u];if(m!==ot&&a.push(h),m!==It&&i.push(m!=ot?h.clone():h),(m|f)===Vr){Ce.sub(O,y.pos,h.pos);let b=(r.w-Ce.dot(r.unsafeNormal,h.pos))/Ce.dot(r.unsafeNormal,O),d=h.interpolate(y,b);a.push(d),i.push(d.clone())}}if(a.length>3)for(let l of kr(a))e.push({polygon:new D(l,s.shared),type:re.Front});else a.length===3&&e.push({polygon:new D(a,s.shared),type:re.Front});if(i.length>3)for(let l of kr(i))e.push({polygon:new D(l,s.shared),type:re.Back});else i.length===3&&e.push({polygon:new D(i,s.shared),type:re.Back});break}}return e.length==0&&e.push(t),e}function kr(s){let r=[];if(s.length>4){console.warn(`[splitPolygonArr] arr.length (${s.length}) > 4`);for(let e=3;e<=s.length;e++)r.push([s[0].clone(),s[e-2].clone(),s[e-1].clone()])}else Ce.squaredDistance(s[0].pos,s[2].pos)<=Ce.squaredDistance(s[1].pos,s[3].pos)?r.push([s[0].clone(),s[1].clone(),s[2].clone()],[s[0].clone(),s[2].clone(),s[3].clone()]):r.push([s[0].clone(),s[1].clone(),s[3].clone()],[s[1].clone(),s[2].clone(),s[3].clone()]);return r}import{vec3 as X}from"gl-matrix";var Et=X.create(),Nt=X.create(),Mt=X.create(),Tt=X.create(),_t=X.create(),Bt=1e-7;function Ft(s,r,e=X.create()){X.sub(Et,r.b,r.a),X.sub(Nt,r.c,r.a),X.cross(Mt,s.direction,Nt);let t=X.dot(Et,Mt);if(t>-Bt&&t<Bt)return null;X.sub(Tt,s.origin,r.a);let o=1/t,n=o*X.dot(Tt,Mt);if(n<0||n>1)return null;X.cross(_t,Tt,Et);let a=o*X.dot(s.direction,_t);if(a<0||n+a>1)return null;let i=o*X.dot(Nt,_t);return i>Bt?X.scaleAndAdd(e,s.origin,s.direction,i):null}function Dt(s,r=15){return s[0]=+s[0].toFixed(r),s[1]=+s[1].toFixed(r),s[2]=+s[2].toFixed(r),s}import{vec3 as w}from"gl-matrix";var oe=w.create(),he=w.create(),jt=w.create(),nt=w.fromValues(1,0,0),st=w.fromValues(0,1,0),at=w.fromValues(0,0,1),fo=w.create(),mo=w.create(),po=w.create(),ho=w.create(),yo=w.create(),bo=w.create(),go=w.create(),vo=w.create(),it=w.create(),ct=w.create(),lt=w.create(),j=class{constructor(r=w.create(),e=w.create()){this.min=r;this.max=e}clone(){return new j(w.clone(this.min),w.clone(this.max))}expandByPoint(r){w.min(this.min,this.min,r),w.max(this.max,this.max,r)}expandByScalar(r){w.set(oe,r,r,r),w.sub(this.min,this.min,oe),w.add(this.max,this.max,oe)}_project(r,e){let t=r.length,o=w.dot(r[0],e),n=o;for(let a=1;a<t;a++){let i=w.dot(r[a],e);o=Math.min(o,i),n=Math.max(n,i)}return[o,n]}_testNormal(r,e,t,o){let[n,a]=this._project(o,t);return a<r||n>e}_testECP(r,e,t,o){let n=w.cross(oe,r,e),[a,i]=this._project(o,n),[c,l]=this._project(t,n);return i<c||a>l}intersectsTriangle(r){let e=[r.a,r.b,r.c];if(this._testNormal(this.min[0],this.max[0],nt,e)||this._testNormal(this.min[1],this.max[1],st,e)||this._testNormal(this.min[2],this.max[2],at,e))return!1;let t=W.calculateNormal(r.a,r.b,r.c),o=w.dot(t,r.a),n=[w.set(fo,this.min[0],this.max[1],this.min[2]),w.set(mo,this.max[0],this.max[1],this.min[2]),w.set(po,this.min[0],this.max[1],this.max[2]),w.set(ho,this.max[0],this.max[1],this.max[2]),w.set(yo,this.min[0],this.min[1],this.min[2]),w.set(bo,this.max[0],this.min[1],this.min[2]),w.set(go,this.min[0],this.min[1],this.max[2]),w.set(vo,this.max[0],this.min[1],this.max[2])],[a,i]=this._project(n,t);return i<o||a>o?!1:(w.sub(it,r.a,r.b),w.sub(ct,r.b,r.c),w.sub(lt,r.c,r.a),!(this._testECP(it,nt,e,n)||this._testECP(it,st,e,n)||this._testECP(it,at,e,n)||this._testECP(ct,nt,e,n)||this._testECP(ct,st,e,n)||this._testECP(ct,at,e,n)||this._testECP(lt,nt,e,n)||this._testECP(lt,st,e,n)||this._testECP(lt,at,e,n)))}intersectsBox(r){return!(this.min[0]>r.max[0]||this.max[0]<r.min[0]||this.min[1]>r.max[1]||this.max[1]<r.min[1]||this.min[2]>r.max[2]||this.max[2]<r.min[2])}intersectsRay(r){w.inverse(jt,r.direction),w.sub(oe,this.min,r.origin),w.mul(oe,oe,jt),w.sub(he,this.max,r.origin),w.mul(he,he,jt);let e=Math.max(oe[0],he[0],oe[1],he[1],oe[2],he[2]);return e<0?!1:Math.min(oe[0],he[0],oe[1],he[1],oe[2],he[2])<=e}containsPoint(r){return r[0]>=this.min[0]&&r[0]<=this.max[0]&&r[1]>=this.min[1]&&r[1]<=this.max[1]&&r[2]>=this.min[2]&&r[2]<=this.max[2]}makeEmpty(){w.set(this.min,0,0,0),w.set(this.max,0,0,0)}};import{vec3 as Er}from"gl-matrix";var Le=class{constructor(){this.origin=Er.create();this.direction=Er.fromValues(0,0,-1)}};var Se=class{constructor(){this.buckets=new Map}isUnique(r){let e=r.hash,t=this.buckets.get(e);if(t){for(let o of t)if(r.equals(o))return!1;t.push(r)}else t=[r];return!0}clear(){this.buckets.clear()}};var Ae={union:{a:[{array:!0,rule:[1,3]},{array:!1,rule:1}],b:[{array:!0,rule:[1,3]},{array:!0,rule:[1,4]},{array:!1,rule:1}]},subtract:{a:[{array:!0,rule:[1,3]},{array:!0,rule:[1,4]},{array:!1,rule:1}],b:[{array:!0,rule:[2,3]},{array:!0,rule:[2,4]},{array:!0,rule:[1,4]},{array:!1,rule:2}]},intersect:{a:[{array:!0,rule:[1,3]},{array:!0,rule:[2,4]},{array:!0,rule:[2,3]},{array:!1,rule:2}],b:[{array:!0,rule:[1,4]},{array:!0,rule:[1,3]},{array:!0,rule:[2,4]},{array:!0,rule:[2,3]},{array:!1,rule:2}]}};import{mat3 as xo,vec3 as _}from"gl-matrix";var Nr=_.create(),ut=_.create(),Mr=_.create(),Te=new Le,ft=_.fromValues(0,0,1);let r;var S=class{constructor(e,t=null){this.polygons=[],this.replacedPolygons=[],this.box=e,this.subTrees=[],this.parent=t,this.level=0,this.polygonArrays=[],this.addPolygonsArrayToRoot(this.polygons)}clone(){return new S().copy(this)}copy(e){var t;this.deletePolygonsArrayFromRoot(this.polygons),this.polygons=e.polygons.map(o=>o.clone()),this.addPolygonsArrayToRoot(this.polygons),this.replacedPolygons=e.replacedPolygons.map(o=>o.clone()),this.box=(t=e.box)==null?void 0:t.clone(),this.level=e.level;for(let o of e.subTrees)this.subTrees.push(new S(void 0,this).copy(o));return this}addPolygonsArrayToRoot(e){this.parent?this.parent.addPolygonsArrayToRoot(e):this.polygonArrays.push(e)}deletePolygonsArrayFromRoot(e){if(this.parent)this.parent.deletePolygonsArrayFromRoot(e);else{let t=this.polygonArrays.indexOf(e);t>-1&&this.polygonArrays.splice(t,1)}}isEmpty(){return this.polygons.length===0}addPolygon(e,t){let o=e.triangle;return t&&!t.isUnique(o)?this:(this.box?(this.box.min[0]=Math.min(this.box.min[0],o.a[0],o.b[0],o.c[0]),this.box.min[1]=Math.min(this.box.min[1],o.a[1],o.b[1],o.c[1]),this.box.min[2]=Math.min(this.box.min[2],o.a[2],o.b[2],o.c[2]),this.box.max[0]=Math.max(this.box.max[0],o.a[0],o.b[0],o.c[0]),this.box.max[1]=Math.max(this.box.max[1],o.a[1],o.b[1],o.c[1]),this.box.max[2]=Math.max(this.box.max[2],o.a[2],o.b[2],o.c[2])):(this.box=new j,this.box.min[0]=Math.min(o.a[0],o.b[0],o.c[0]),this.box.min[1]=Math.min(o.a[1],o.b[1],o.c[1]),this.box.min[2]=Math.min(o.a[2],o.b[2],o.c[2]),this.box.max[0]=Math.max(o.a[0],o.b[0],o.c[0]),this.box.max[1]=Math.max(o.a[1],o.b[1],o.c[1]),this.box.max[2]=Math.max(o.a[2],o.b[2],o.c[2])),this.polygons.push(e),this)}split(e){if(!this.box)throw new Error("Octree has no box");let t=[];_.sub(ut,this.box.max,this.box.min);let o=_.scale(ut,ut,.5);for(let a=0;a<2;a++)for(let i=0;i<2;i++)for(let c=0;c<2;c++){let l=new j,u=_.set(Nr,a,i,c);_.multiply(Mr,u,o),_.add(l.min,this.box.min,Mr),_.add(l.max,l.min,o),l.expandByScalar(1e-5),t.push(new S(l,this))}let n;for(;n=this.polygons.pop();){let a=!1;for(let i=0;i<t.length;i++){let c=t[i],l=c.box;if(!l)throw new Error("Subtree has no box");l.containsPoint(n.midpoint)&&(c.polygons.push(n),a=!0)}if(!a)throw console.error("ERROR: unable to find subtree for:",n.triangle),new Error(`Unable to find subtree for triangle at level ${e}`)}for(let a of t)a.level=e+1,a.polygons.length>S.polygonsPerTree&&e<S.maxLevel&&a.split(e+1),this.subTrees.push(a);return this}buildTree(){return this.split(0),this.processTree(),this}processTree(){if(!this.isEmpty()){this.box||(this.box=new j);let t=this.polygons[0].triangle.a;_.copy(this.box.min,t),_.copy(this.box.max,t);for(let o of this.polygons)this.box.expandByPoint(o.triangle.a),this.box.expandByPoint(o.triangle.b),this.box.expandByPoint(o.triangle.c);this.expandParentBox()}for(let e of this.subTrees)e.processTree()}expandParentBox(){if(this.parent){if(!this.box)throw new Error("Octree has no box");if(!this.parent.box)throw new Error("Octree's parent has no box");this.parent.box.expandByPoint(this.box.min),this.parent.box.expandByPoint(this.box.max),this.parent.expandParentBox()}}getPolygonsIntersectingPolygon(e,t=[]){if(!this.box)throw new Error("Octree has no box");this.polygons.length>0&&this.box.intersectsTriangle(e.triangle)&&(_r(e,t,this.polygons),_r(e,t,this.replacedPolygons));for(let o of this.subTrees)o.getPolygonsIntersectingPolygon(e,t);return t}getRayPolygons(e,t){if(t)for(let o of this.replacedPolygons)t.add(o);else t=new Set(this.replacedPolygons);for(let o of this.polygons)o.valid&&o.originalValid&&t.add(o);for(let o of this.subTrees)o.box.intersectsRay(e)&&o.getRayPolygons(e,t);return t}rayIntersect(e,t=[]){if(_.squaredLength(e.direction)===0)return[];let o=1e100;for(let n of this.getRayPolygons(e)){let a=Ft(e,n.triangle,Nr);if(a){let i=_.distance(a,e.origin);o>i&&(o=i),o<1e100&&t.push({distance:o,polygon:n,position:_.add(_.create(),a,e.origin)})}}return t.length&&t.sort(Po),t}getIntersectingPolygons(e=[]){for(let t of this.polygonArrays)for(let o of t)o.valid&&o.intersects&&e.push(o);return e}getPolygons(e=[]){for(let t of this.polygonArrays)for(let o of t)o.valid&&e.indexOf(o)===-1&&e.push(o);return e}invert(){for(let e of this.polygonArrays)for(let t of e)t.valid&&t.flip()}replacePolygon(e,t){if(Array.isArray(t)||(t=[t]),this.polygons.length>0){let o=this.polygons.indexOf(e);o>-1&&(e.originalValid?this.replacedPolygons.push(e):e.setInvalid(),this.polygons.splice(o,1,...t))}for(let o of this.subTrees)o.replacePolygon(e,t)}deletePolygonsByStateRules(e,t=!0){for(let o of this.polygonArrays)if(o.length!==0)for(let n of o.slice()){if(!n.valid||!n.intersects)continue;let a=!1;for(let i of e)if(i.array){let c=i.rule;if(c.includes(n.state)&&(n.previousState!==0&&c.includes(n.previousState)||n.previousState===0)){a=!0;let l=new Set;for(let u of c)l.add(u);l.delete(n.state);for(let u of n.previousStates)if(c.includes(u))l.delete(u);else{a=!1;break}if(a)if(l.size>0)a=!1;else break}}else if(n.checkAllStates(i.rule)){a=!0;break}if(a){let i=o.indexOf(n);i>-1&&(n.setInvalid(),o.splice(i,1)),t&&n.delete()}}}deletePolygonsByIntersection(e,t=!0){for(let o of this.polygonArrays)if(o.length!==0){for(let n of o.slice())if(n.valid&&n.intersects===e){let a=o.indexOf(n);a>-1&&(n.setInvalid(),o.splice(a,1)),t&&n.delete()}}}isPolygonIntersecting(e){if(!this.box)throw new Error("Octree has no box");return this.box.intersectsTriangle(e.triangle)}markIntersectingPolygons(e){for(let t of this.polygonArrays)for(let o of t)o.intersects=e.isPolygonIntersecting(o)}resetPolygons(e=!0){for(let t of this.polygonArrays)for(let o of t)o.reset(e)}handleIntersectingPolygons(e,t){if(S.useWindingNumber&&!t)throw new Error("targetOctreeBuffer must be set if using winding number");if(this.polygons.length>0){let o=this.polygons.filter(i=>i.valid&&i.intersects&&i.state===0),n;for(;n=o.pop();){if(n.state!==0||!n.valid)continue;let i=e.getPolygonsIntersectingPolygon(n);for(let c of i){let l=Ir(n,c.plane);if(l.length>1){for(let u of l){let m=u.polygon;m.intersects=n.intersects,m.newPolygon=!0,o.push(m)}this.replacePolygon(n,l.map(u=>u.polygon));break}else{let u=l[0];if(n.id!==u.polygon.id){u.polygon.intersects=n.intersects,u.polygon.newPolygon=!0,o.push(u.polygon),this.replacePolygon(n,u.polygon);break}else(u.type===re.CoplanarFront||u.type===re.CoplanarBack)&&(n.setState(u.type),n.coplanar=!0)}}}o=this.polygons.filter(i=>i.valid&&i.intersects);let a=!1;for(;n=o.pop();)if(!!n.valid){if(!e.box)throw new Error("Octree has no box");if(a=!1,e.box.containsPoint(n.midpoint))if(S.useWindingNumber)a=gr(t,n.midpoint,n.coplanar);else{let i=Dt(_.copy(ut,n.midpoint));_.copy(Te.origin,i),_.copy(ft,n.plane.unsafeNormal),_.copy(Te.direction,n.plane.unsafeNormal);let c=e.rayIntersect(Te);if(c.length>0&&_.dot(ft,c[0].polygon.plane.unsafeNormal)>0)a=!0;else if(n.coplanar){for(let l of Ct)if(_.add(Te.origin,i,l),_.copy(ft,n.plane.unsafeNormal),_.copy(Te.direction,n.plane.unsafeNormal),c=e.rayIntersect(Te),c.length>0&&_.dot(ft,c[0].polygon.plane.unsafeNormal)>0){a=!0;break}}}n.setState(a?1:2)}}for(let o of this.subTrees)o.handleIntersectingPolygons(e,t)}delete(e=!0){if(this.polygons.length>0&&e){for(let t of this.polygons)t.delete();this.polygons.length=0}if(this.replacedPolygons.length>0&&e){for(let t of this.replacedPolygons)t.delete();this.replacedPolygons.length=0}if(this.polygonArrays&&(this.polygonArrays.length=0),this.subTrees.length){for(let t of this.subTrees)t.delete(e);this.subTrees.length=0}this.box=void 0,this.parent=null,this.level=0}dispose(e=!0){this.delete(e)}getPolygonCloneCallback(e,t){for(let o of this.polygonArrays)for(let n of o)n.valid&&e(n.clone(),t)}deleteReplacedPolygons(){if(this.replacedPolygons.length>0){for(let e of this.replacedPolygons)e.delete();this.replacedPolygons.length=0}for(let e of this.subTrees)e.deleteReplacedPolygons()}markPolygonsAsOriginal(){for(let e of this.polygonArrays)for(let t of e)t.originalValid=!0}applyMatrix(e,t,o=!0){this.box&&(this.box=void 0),t||(t=xo.normalFromMat4(tt,e));for(let n of this.polygons)n.valid&&n.applyMatrix(e,t);for(let n of this.subTrees)n.applyMatrix(e,t,!1);o&&this.processTree()}setPolygonIndex(e){if(e!==void 0)for(let t of this.polygonArrays)for(let o of t)o.shared=e}getTriangles(e=[]){for(let t of this.getPolygons())e.push(t.triangle);return e}getRayTriangles(e,t=[]){for(let o of this.getRayPolygons(e))t.push(o.triangle);return t}static union(e,t,o=!0){e.box||e.buildTree(),t.box||t.buildTree();let n=new S,a=new Se;return e.box.intersectsBox(t.box)&&(e.resetPolygons(!1),t.resetPolygons(!1),e.markIntersectingPolygons(t),t.markIntersectingPolygons(e),S.handleIntersectingOctrees(e,t),e.deleteReplacedPolygons(),t.deleteReplacedPolygons(),e.deletePolygonsByStateRules(Ae.union.a),t.deletePolygonsByStateRules(Ae.union.b)),e.getPolygonCloneCallback(n.addPolygon.bind(n),a),t.getPolygonCloneCallback(n.addPolygon.bind(n),a),a.clear(),n.markPolygonsAsOriginal(),o&&n.buildTree(),n}static subtract(e,t,o=!0){e.box||e.buildTree(),t.box||t.buildTree();let n=new S,a=new Se;return e.box.intersectsBox(t.box)?(e.resetPolygons(!1),t.resetPolygons(!1),e.markIntersectingPolygons(t),t.markIntersectingPolygons(e),S.handleIntersectingOctrees(e,t),e.deleteReplacedPolygons(),t.deleteReplacedPolygons(),e.deletePolygonsByStateRules(Ae.subtract.a),t.deletePolygonsByStateRules(Ae.subtract.b),t.deletePolygonsByIntersection(!1),t.invert(),e.getPolygonCloneCallback(n.addPolygon.bind(n),a),t.getPolygonCloneCallback(n.addPolygon.bind(n),a)):e.getPolygonCloneCallback(n.addPolygon.bind(n),a),a.clear(),n.markPolygonsAsOriginal(),o&&n.buildTree(),n}static intersect(e,t,o=!0){e.box||e.buildTree(),t.box||t.buildTree();let n=new S,a=new Se;return e.box.intersectsBox(t.box)&&(e.resetPolygons(!1),t.resetPolygons(!1),e.markIntersectingPolygons(t),t.markIntersectingPolygons(e),S.handleIntersectingOctrees(e,t),e.deleteReplacedPolygons(),t.deleteReplacedPolygons(),e.deletePolygonsByStateRules(Ae.intersect.a),t.deletePolygonsByStateRules(Ae.intersect.b),e.deletePolygonsByIntersection(!1),t.deletePolygonsByIntersection(!1),e.getPolygonCloneCallback(n.addPolygon.bind(n),a),t.getPolygonCloneCallback(n.addPolygon.bind(n),a)),a.clear(),n.markPolygonsAsOriginal(),o&&n.buildTree(),n}static unionArray(e,t=1/0){return Br(S.union,e,t)}static subtractArray(e,t=1/0){let o=e.length;if(o===0)throw new Error("Unable to find any result octree");return o===1?e[0]:o===2?S.subtract(e[0],e[1]):S.subtract(e[0],S.unionArray(e.slice(1),t))}static intersectArray(e,t=1/0){return Br(S.intersect,e,t)}static operation(e,t=!0){let o;switch(e.op){case"union":case"subtract":case"intersect":{let n=mt(e.objA,t),a=mt(e.objB,t);switch(e.op){case"union":o=S.union(n,a,t);break;case"subtract":o=S.subtract(n,a,t);break;default:o=S.intersect(n,a,t)}_e(n,a);break}case"unionArray":case"subtractArray":case"intersectArray":{let n=new Array;for(let a of e.objs)n.push(mt(a,t));switch(e.op){case"unionArray":o=S.unionArray(n);break;case"subtractArray":o=S.subtractArray(n);break;default:o=S.intersectArray(n)}_e(...n);break}default:throw new Error(`Unknown operation: ${e.op}`)}return o}static handleIntersectingOctrees(e,t,o=!0,n,a){S.useWindingNumber&&(o&&!n&&(n=ze(e.getPolygons())),a||(a=ze(t.getPolygons()))),e.handleIntersectingPolygons(t,a),o&&t.handleIntersectingPolygons(e,n),n!==void 0&&(n=void 0,a=void 0)}},E=S;E.disposeOctree=!0,E.useWindingNumber=!1,E.maxLevel=16,E.polygonsPerTree=100,E.async={batchSize:100,union(e,t,o=!0){return Re(this,null,function*(){return Ut("union",S.union,e,t,o)})},subtract(e,t,o=!0){return Ut("subtract",S.subtract,e,t,o)},intersect(e,t,o=!0){return Ut("intersect",S.intersect,e,t,o)},unionArray(e,t=1/0){return Fr(S.async.union,S.async.unionArray,e,t)},subtractArray(e,t=1/0){return Re(this,null,function*(){let o=e.length;if(o===0)throw new Error("Unable to find any result octree");return o===1?e[0]:o===2?yield S.async.subtract(e[0],e[1]):yield S.async.subtract(e[0],yield S.async.unionArray(e.slice(1),t))})},intersectArray(e,t=1/0){return Fr(S.async.intersect,S.async.intersectArray,e,t)},operation(e,t=!0){return new Promise((o,n)=>{try{switch(e.op){case"union":case"subtract":case"intersect":{let a,i,c=[];e.objA&&c.push(Tr(e.objA,t,0)),e.objB&&c.push(Tr(e.objB,t,1)),Promise.allSettled(c).then(l=>{for(let m of l)if(m.status==="fulfilled"){let[f,h]=m.value;h===0?a=f:h===1&&(i=f)}let u;switch(e.op){case"union":u=S.async.union(a,i,t);break;case"subtract":u=S.async.subtract(a,i,t);break;default:u=S.async.intersect(a,i,t)}u.then(m=>{o(m),_e(a,i)}).catch(m=>n(m))});break}case"unionArray":case"subtractArray":case"intersectArray":{let a=new Array;for(let c of e.objs)a.push(mt(c,t));let i;switch(e.op){case"unionArray":i=S.async.unionArray(a);break;case"subtractArray":i=S.async.subtractArray(a);break;default:i=S.async.intersectArray(a)}_e(...a),i.then(c=>o(c));break}default:throw new Error(`Unknown operation: ${e.op}`)}}catch(a){n(a)}})}};function Po(s,r){return s.distance-r.distance}function mt(s,r){if(s instanceof E)return s;if(s.op)return E.operation(s,r);throw new Error("Invalid OctreeCSG operation object")}function Tr(s,r,e){return new Promise((t,o)=>{try{if(s instanceof E)t([s,e]);else if(s.op)E.async.operation(s,r).then(n=>{t([n,e])});else throw new Error("Invalid OctreeCSG operation object")}catch(n){o(n)}})}function _e(...s){if(E.disposeOctree)for(let r of s)r.delete()}function _r(s,r,e){for(let t of e)t.originalValid&&t.valid&&t.intersects&&Pr(s.triangle,t.triangle)&&r.push(t)}function Br(s,r,e){let t=new Array,o=r.length;for(let n=0;n<o;n++){let a=r[n];a.setPolygonIndex(n>e?e:n),t.push(a)}for(;t.length>1;){let n=t.length,a=new Array,i=0;for(;i+1<n;i+=2){let c=t[i],l=t[i+1],u=s(c,l);_e(c,l),a.push(u)}i<n&&a.push(t[i]),t=a}if(t.length===0)throw new Error("Unable to find any result octree");return t[0]}function Ut(s,r,e,t,o=!0){return Re(this,null,function*(){if(globalThis.globalOctreeCSGJobDispatcher)try{return yield globalThis.globalOctreeCSGJobDispatcher.dispatch({op:s,objA:e,objB:t})}catch(a){let i=!0;if(a instanceof te&&a.failReason===0&&(console.warn("Queued job failed due to worker creation failure. Retrying synchronously"),i=!1),i)throw a}let n=r(e,t,o);return _e(e,t),n})}function Fr(s,r,e,t){return new Promise((o,n)=>{try{let a=E.async.batchSize>4&&E.async.batchSize<e.length,i,c=!1,l=[];if(a){let u=[],m=0;for(;m<e.length;)u.push(e.slice(m,m+E.async.batchSize)),m+=E.async.batchSize;let f;for(;f=u.shift();)l.push(r(f,0));c=!0,e.length=0}else{let u=[],m=e.length;for(let y=0;y<m;y++){let b=e[y];t>-1&&b.setPolygonIndex(y>t?t:y),u.push(b)}i=u.shift();let f,h=u.length;for(let y=0;y<h;y+=2){if(y+1>=h){f=u[y];break}l.push(s(u[y],u[y+1]))}f&&(l.push(s(i,f)),c=!0)}Promise.allSettled(l).then(u=>{let m=new Array;for(let f of u)f.status==="fulfilled"&&m.push(f.value);c||m.unshift(i),m.length<=0?n("Unable to find any result octree"):m.length===1?o(m[0]):m.length>3?r(m,a?0:-1).then(f=>{o(f)}).catch(f=>n(f)):s(m[0],m[1]).then(f=>{m.length===3?s(f,m[2]).then(h=>{o(h)}).catch(h=>n(h)):o(f)}).catch(f=>n(f))})}catch(a){n(a)}})}import{vec3 as Oe}from"gl-matrix";var g=class{constructor(r,e){this.pos=r;this.normal=e}clone(){return new g(Oe.clone(this.pos),Oe.clone(this.normal))}flip(){Oe.negate(this.normal,this.normal)}delete(){this.pos=void 0,this.normal=void 0}interpolate(r,e){return new g(Oe.lerp(Oe.create(),this.pos,r.pos,e),Oe.lerp(Oe.create(),this.normal,r.normal,e))}};function Wt(s,r){let e=s.length;if(e%9!==0)throw new Error("Vertex buffer length is not a multiple of 9");if(r.length%9!==0)throw new Error("Normal buffer length is not a multiple of 9");let t=new E;for(let o=0;o<e;){let n=new g(s.slice(o,o+3),r.slice(o,o+3));o+=3;let a=new g(s.slice(o,o+3),r.slice(o,o+3));o+=3;let i=new g(s.slice(o,o+3),r.slice(o,o+3));o+=3;let c=new D([n,a,i]);c.originalValid=!0,t.addPolygon(c)}return t}function Dr(s,r){switch(s.op){case"union":case"subtract":case"intersect":return{op:s.op,objA:Jt(s.objA,r),objB:Jt(s.objB,r)};case"unionArray":case"subtractArray":case"intersectArray":{let e=new Array;for(let t of s.objs)e.push(Jt(t,r));return{op:s.op,objs:e}}default:throw new Error(`Unknown operation: ${s.op}`)}}function Jt(s,r){return s instanceof E?St(s,r):Dr(s,r)}var He=class{constructor(r,e,t){this.resolveCallback=e;this.rejectCallback=t;this.workerIndex=null;this.transferables=[],this.operation=Dr(r,this.transferables)}getMessage(r,e){if(!(this.operation&&this.transferables))throw new Error("Message already created");let t=this.operation,o=this.transferables;return this.operation=null,this.transferables=null,this.workerIndex=r,[{type:"operation",jobIndex:e,operation:t},o]}resolve(r,e){try{this.resolveCallback(Wt(r,e))}catch(t){this.rejectCallback(te.DecodeFailure(t))}}reject(r){this.rejectCallback(r)}};var jr="OctreeCSG job dispatcher worker creation",zt=`Skipped ${jr}; `,Be=class{constructor(){this.workers=null;this.nextJobIndex=0;this.waitingJobs=new Map;this.jobCounts=new Array}initWorker(r,e,t){return new Promise((o,n)=>{let a=setTimeout(()=>{i.terminate(),n(new Error("Timed out"))},t),i=new Worker(e,{type:"classic"});i.onmessage=c=>{if(clearTimeout(a),c.data==="initialized"){let l=r.length;r.push(i),i.onmessage=this.makeMessageHandler(l),o(void 0)}else i.terminate(),n(new Error("Unexpected initialization message"))}})}init(r,e,t){return new Promise((o,n)=>{let a=new Array,i=0;for(let c=0;c<e;c++)this.initWorker(a,r,t).catch(l=>{console.error("Failed to create OctreeCSG worker:",l.message)}).finally(()=>{if(++i===e){let l=a.length;if(l===0){n(new Error("All OctreeCSG workers failed to be created"));return}else l!==e?console.warn(`Some OctreeCSG workers failed to be created. Created ${l} workers instead of ${e}`):console.info(`Created ${l} OctreeCSG workers`);this.workers=a,o(void 0)}})})}makeMessageHandler(r){let e=this;return function(t){e.handleMessage(r,t)}}handleMessage(r,e){this.jobCounts[r]--;let t=e.data.jobIndex,o=this.waitingJobs.get(t);this.waitingJobs.delete(t),e.data.success?o.resolve(e.data.vertices,e.data.normals):o.reject(te.OperationFailure(e.data.error))}doDispatch(r,e){let t=0,o=this.jobCounts[0],n=this.jobCounts.length;for(let i=1;i<n;i++){let c=this.jobCounts[i];c<o&&(t=i,o=c)}this.workers[t].postMessage(...e.getMessage(t,r))}dispatch(r){return new Promise((e,t)=>{let o=new He(r,e,t),n=this.nextJobIndex++;this.waitingJobs.set(n,o),this.workers&&this.doDispatch(n,o)})}static create(r,e,t){return Re(this,null,function*(){if(globalThis.globalOctreeCSGJobDispatcher){console.warn(`${zt}already created`);return}else if(globalThis.globalOctreeCSGJobDispatcher===null){console.warn(`${zt}previous creation failed`);return}let o;if(globalThis.Worker){try{o=new Be,globalThis.globalOctreeCSGJobDispatcher=o,yield o.init(r,e,t)}catch(n){if(console.error(`${jr} failed:`,n),globalThis.globalOctreeCSGJobDispatcher=null,o){for(let a of o.waitingJobs.values())a.reject(te.WorkerCreationFailure(n));o.waitingJobs.clear()}throw n}for(let[n,a]of o.waitingJobs)o.doDispatch(n,a)}else{console.warn(`${zt}Worker API not supported`);return}})}};import{vec3 as F}from"gl-matrix";import{mat4 as q}from"gl-matrix";var H=class extends E{constructor(r,e,t){let o=e.length;if(o%3!==0)throw new Error("Input triangle vertices array has a non-multiple-of-three length");super(r);for(let n=0;n<o;n+=3){let a=new D(e.slice(n,n+3));a.originalValid=!0,this.polygons.push(a)}if(!!t){if("matrix"in t){let n=t.matrix;this.applyMatrix(n,t.normalMatrix)}else if(t.rotation||t.translation||t.scale){let n=q.create();if(t.rotation&&t.translation)t.scale?q.fromRotationTranslationScale(n,t.rotation,t.translation,t.scale):q.fromRotationTranslation(n,t.rotation,t.translation);else if(t.translation)t.scale?(q.identity(n),q.translate(n,n,t.translation),q.scale(n,n,t.scale)):q.fromTranslation(n,t.translation);else if(t.rotation)if(t.scale){q.identity(n);let a=q.create();q.fromQuat(a,t.rotation),q.multiply(n,n,a),q.scale(n,n,t.scale)}else q.fromQuat(n,t.rotation);else q.fromScaling(n,t.scale);this.applyMatrix(n)}}}};function Fe(s,r,e,t,o,n,a){return s[r++]=new g(F.clone(e),F.clone(a)),s[r++]=new g(t,F.clone(a)),s[r++]=new g(F.clone(o),F.clone(a)),s[r++]=new g(o,F.clone(a)),s[r++]=new g(n,F.clone(a)),s[r++]=new g(e,a),r}var Ye=class extends H{constructor(r,e,t,o){r*=.5,e*=.5,t*=.5;let n=F.fromValues(r,e,t),a=F.negate(F.create(),n),i=F.fromValues(-r,e,t),c=F.fromValues(r,e,t),l=F.fromValues(-r,e,-t),u=F.fromValues(r,e,-t),m=F.fromValues(-r,-e,t),f=F.fromValues(r,-e,t),h=F.fromValues(-r,-e,-t),y=F.fromValues(r,-e,-t),b=new Array(36),d=Fe(b,0,i,c,u,l,F.fromValues(0,1,0));d=Fe(b,d,h,y,f,m,F.fromValues(0,-1,0)),d=Fe(b,d,u,c,f,y,F.fromValues(1,0,0)),d=Fe(b,d,h,m,i,l,F.fromValues(-1,0,0)),d=Fe(b,d,f,c,i,m,F.fromValues(0,0,1)),Fe(b,d,h,l,u,y,F.fromValues(0,0,-1)),super(new j(a,n),b,o)}};var $t=class extends Ye{constructor(r=1,e){super(r,r,r,e)}};import{vec3 as Ge}from"gl-matrix";function De(s,r,e,t,o,n,a,i){for(let c=0;c<e;c++){let l=c/e,u=(c+1)/e;for(let m=0;m<e;m++){let f=m/e,h=(m+1)/e,[y,b]=s(l,f,t,n,a,i),[d,v]=s(u,f,t,n,a,i),[C,V]=s(u,h,t,n,a,i),[N,M]=s(l,h,t,n,a,i);o[r++]=new g(Ge.clone(y),Ge.clone(b)),o[r++]=new g(d,v),o[r++]=new g(Ge.clone(C),Ge.clone(V)),o[r++]=new g(C,V),o[r++]=new g(N,M),o[r++]=new g(y,b)}}return r}var Ve=class extends H{constructor(r,e=1,t){var m;let o=(m=t==null?void 0:t.subDivisions)!=null?m:4,n=36*o*o,a=new Array(n),i=e/2,c=De(r,0,o,i,a,[1,-1,1],[0,0,-2],[0,2,0]);c=De(r,c,o,i,a,[-1,-1,-1],[0,0,2],[0,2,0]),c=De(r,c,o,i,a,[-1,1,1],[2,0,0],[0,0,-2]),c=De(r,c,o,i,a,[1,-1,1],[-2,0,0],[0,0,-2]),c=De(r,c,o,i,a,[-1,-1,1],[2,0,0],[0,2,0]),De(r,c,o,i,a,[1,-1,-1],[-2,0,0],[0,2,0]);let l=Ge.fromValues(i,i,i),u=Ge.negate(Ge.create(),l);super(new j(u,l),a,t)}};import{vec3 as ke}from"gl-matrix";function wo(s,r,e,t,o,n){ke.copy(O,t),ke.scaleAndAdd(O,O,o,s),ke.scaleAndAdd(O,O,n,r),ke.multiply($,O,O);let a=ke.fromValues(O[0]*Math.sqrt(1-.5*($[1]+$[2])+$[1]*$[2]*Ie),O[1]*Math.sqrt(1-.5*($[2]+$[0])+$[2]*$[0]*Ie),O[2]*Math.sqrt(1-.5*($[0]+$[1])+$[0]*$[1]*Ie));return[ke.scale(ke.create(),a,e),a]}var Lt=class extends Ve{constructor(r=1,e){super(wo,r,e)}};import{vec3 as je}from"gl-matrix";function Co(s,r,e,t,o,n){je.copy(O,t),je.scaleAndAdd(O,O,o,s),je.scaleAndAdd(O,O,n,r);let a=je.normalize(O,O);return[je.scale(je.create(),a,e),a]}var Ht=class extends Ve{constructor(r=1,e){super(Co,r,e)}};import{vec3 as Y}from"gl-matrix";import{vec3 as Yt}from"gl-matrix";import{vec3 as Ur}from"gl-matrix";function pt(s,r=!1,e,t=0){let o=s.length;if(o<3)throw new Error(`Expected input polyline with 3 or more vertices, got ${o}`);if(e||(e=new Array(t+(o-2)*3)),o===3)return r?(e[t++]=s[2].clone(),e[t++]=s[1].clone(),e[t++]=s[0].clone()):(e[t++]=s[0].clone(),e[t++]=s[1].clone(),e[t++]=s[2].clone()),[e,t];if(o===4)return r?(e[t++]=s[2].clone(),e[t++]=s[1].clone(),e[t++]=s[0].clone()):(e[t++]=s[0].clone(),e[t++]=s[1].clone(),e[t++]=s[2].clone()),Ur.squaredDistance(s[0].pos,s[2].pos)<=Ur.squaredDistance(s[1].pos,s[3].pos)?e[t++]=s[0].clone():e[t++]=s[1].clone(),r?(e[t++]=s[3].clone(),e[t++]=s[2].clone()):(e[t++]=s[2].clone(),e[t++]=s[3].clone()),[e,t];let n=Array.from({length:o},(a,i)=>i);n.sort((a,i)=>{let c=s[a],l=s[i];return c.pos[0]<l.pos[0]?-1:c.pos[0]>l.pos[0]?1:c.pos[1]<l.pos[1]?-1:c.pos[1]>l.pos[1]?1:c.pos[2]<l.pos[2]?-1:c.pos[2]>l.pos[2]?1:0});for(let a=2;a<o;a++){let i=n[a-2],c=n[a-1],l=n[a];i>c&&([i,c]=[c,i]),c>l&&([c,l]=[l,c],i>c&&([i,c]=[c,i])),r&&([l,i]=[i,l]),e[t++]=s[l].clone(),e[t++]=s[i].clone(),e[t++]=s[c].clone()}return[e,t]}function Xe(s,r,e,t,o,n){let a=r.length,i=new Array(a);for(let c=0;c<a;c++)i[c]=new g(Yt.fromValues(r[c][0],e,r[c][1]),Yt.clone(t));return pt(i,n,s,o)[1]}function ht(s,r,e){let t=new Array(s);for(let o=0;o<s;o++){let n=Q*(s-1-o)/s,a=Math.cos(n),i=Math.sin(n);e?t[o]=[r*a,r*i,Yt.fromValues(a,0,i)]:t[o]=[r*a,r*i]}return t}var Xt=class extends H{constructor(r=1,e=1,t){var h;let o=(h=t==null?void 0:t.subDivisions)!=null?h:12,n=(o-2)*6+o*6,a=new Array(n),i=r/2,c=e/2,l=ht(o,i,!0),u=Xe(a,l,c,Y.fromValues(0,1,0),0,!1);u=Xe(a,l,-c,Y.fromValues(0,-1,0),u,!0);for(let y=0;y<o;y++){let[b,d,v]=l[y],[C,V,N]=l[(y+1)%o];a[u++]=new g(Y.fromValues(C,c,V),Y.clone(N)),a[u++]=new g(Y.fromValues(b,c,d),Y.clone(v)),a[u++]=new g(Y.fromValues(b,-c,d),Y.clone(v)),a[u++]=new g(Y.fromValues(b,-c,d),Y.clone(v)),a[u++]=new g(Y.fromValues(C,-c,V),Y.clone(N)),a[u++]=new g(Y.fromValues(C,c,V),Y.clone(N))}let m=Y.fromValues(i,c,i),f=Y.negate(Y.create(),m);super(new j(f,m),a,t)}};import{vec3 as le}from"gl-matrix";var Ue=class extends H{constructor(r,e,t,o,n){let a=(r-2)*3+r*3,i=new Array(a),c=t/2,l=o/2,u=le.fromValues(0,l,0),m=ht(r,c,e);if(e){let b=Math.atan(c/o),d=Math.cos(b),v=Math.sin(b);for(let C=0;C<r;C++){let V=m[C][2];V[0]*=d,V[1]=v,V[2]*=d}}let f=Xe(i,m,-l,le.fromValues(0,-1,0),0,!0);for(let b=0;b<r;b++){let d=m[b],v=m[(b+1)%r],[C,V]=d,[N,M]=v,A=le.fromValues(N,-l,M),I=le.clone(u),T=le.fromValues(C,-l,V),L,Z,ie;e?(L=d[2],Z=le.fromValues(0,1,0),ie=v[2]):L=Z=ie=W.calculateNormal(A,I,T),i[f++]=new g(A,le.clone(ie)),i[f++]=new g(I,Z),i[f++]=new g(T,le.clone(L))}let h=le.fromValues(c,l,c),y=le.negate(le.create(),h);super(new j(y,h),i,n)}};var Kt=class extends Ue{constructor(r=1,e=1,t){var o;super((o=t==null?void 0:t.subDivisions)!=null?o:12,!0,r,e,t)}};var Zt=class extends Ue{constructor(r,e=1,t=1,o){super(r,!1,e,t,o)}};import{vec3 as ue}from"gl-matrix";import{vec3 as ae}from"gl-matrix";var x=[ae.fromValues(0,1,0),ae.fromValues(.276385,.447215,-.85064),ae.fromValues(-.7236,.447215,-.52572),ae.fromValues(-.7236,.447215,.52572),ae.fromValues(.276385,.447215,.85064),ae.fromValues(.894425,.447215,0),ae.fromValues(-.276385,-.447215,-.85064),ae.fromValues(-.894425,-.447215,0),ae.fromValues(-.276385,-.447215,.85064),ae.fromValues(.7236,-.447215,.52572),ae.fromValues(.7236,-.447215,-.52572),ae.fromValues(0,-1,0)];function Ke(s,r,e){let t=s(r,0,e,x[0],x[1],x[2]);t=s(r,t,e,x[0],x[2],x[3]),t=s(r,t,e,x[0],x[3],x[4]),t=s(r,t,e,x[0],x[4],x[5]),t=s(r,t,e,x[0],x[5],x[1]),t=s(r,t,e,x[1],x[6],x[2]),t=s(r,t,e,x[2],x[6],x[7]),t=s(r,t,e,x[2],x[7],x[3]),t=s(r,t,e,x[3],x[7],x[8]),t=s(r,t,e,x[3],x[8],x[4]),t=s(r,t,e,x[4],x[8],x[9]),t=s(r,t,e,x[4],x[9],x[5]),t=s(r,t,e,x[5],x[9],x[10]),t=s(r,t,e,x[5],x[10],x[1]),t=s(r,t,e,x[1],x[10],x[6]),t=s(r,t,e,x[11],x[7],x[6]),t=s(r,t,e,x[11],x[8],x[7]),t=s(r,t,e,x[11],x[9],x[8]),t=s(r,t,e,x[11],x[10],x[9]),s(r,t,e,x[11],x[6],x[10])}function So(s,r,e,t,o,n){let a=W.calculateNormal(t,o,n);return s[r++]=new g(ue.scale(ue.create(),t,e),ue.clone(a)),s[r++]=new g(ue.scale(ue.create(),o,e),ue.clone(a)),s[r++]=new g(ue.scale(ue.create(),n,e),a),r}var Qt=class extends H{constructor(r=1,e){let t=r/2,o=ue.fromValues(t,t,t),n=ue.negate(ue.create(),o),a=new Array(60);Ke(So,a,t),super(new j(n,o),a,e)}};import{vec3 as z}from"gl-matrix";function Ze(s,r,e,t,o,n,a){if(s<=0)r[e++]=new g(z.scale(z.create(),o,t),z.clone(o)),r[e++]=new g(z.scale(z.create(),n,t),z.clone(n)),r[e++]=new g(z.scale(z.create(),a,t),z.clone(a));else{let i=z.add(z.create(),o,n);z.normalize(i,i);let c=z.add(z.create(),n,a);z.normalize(c,c);let l=z.add(z.create(),a,o);z.normalize(l,l);let u=s-1;e=Ze(u,r,e,t,o,i,l),e=Ze(u,r,e,t,i,n,c),e=Ze(u,r,e,t,i,c,l),e=Ze(u,r,e,t,l,c,a)}return e}var qt=class extends H{constructor(r=1,e){var c;let t=r/2,o=z.fromValues(t,t,t),n=z.negate(z.create(),o),a=(c=e==null?void 0:e.subDivisions)!=null?c:2,i=new Array(60*pr(4,a));Ke(Ze.bind(null,a),i,t),super(new j(n,o),i,e)}};import{mat4 as er,quat as Wr,vec3 as K}from"gl-matrix";var tr=class extends H{constructor(r=1,e=.5,t){var y,b;let o=(y=t==null?void 0:t.radialSubDivisions)!=null?y:8,n=(b=t==null?void 0:t.tubularSubDivisions)!=null?b:16,a=r/2,i=e/2,c=a-i,l=K.fromValues(a,c,a),u=K.negate(K.create(),l),m=new Array(n);for(let d=0;d<n;d++){let v=new Array(o);m[d]=v;let C=Wr.fromEuler(Wr.create(),0,360*d/n,0);K.set(O,i+c,0,0),er.fromTranslation($e,O),er.fromQuat(kt,C),er.multiply($e,kt,$e);for(let V=0;V<o;V++){let N=Q*V/o,M=Math.cos(N),A=Math.sin(N),I=K.fromValues(M*c,A*c,0);K.transformMat4(I,I,$e);let T=K.fromValues(M,A,0);K.transformQuat(T,T,C),v[V]=[I,T]}}let f=new Array(n*o*6),h=0;for(let d=0;d<n;d++){let v=m[d],C=m[(d+1)%n];for(let V=0;V<o;V++){let N=(V+1)%o,[M,A]=v[V],[I,T]=C[V],[L,Z]=v[N],[ie,ge]=C[N];f[h++]=new g(K.clone(L),K.clone(Z)),f[h++]=new g(M,A),f[h++]=new g(K.clone(I),K.clone(T)),f[h++]=new g(K.clone(I),K.clone(T)),f[h++]=new g(K.clone(ie),K.clone(ge)),f[h++]=new g(L,Z)}}super(new j(u,l),f,t)}};import{vec3 as B,vec2 as yt}from"gl-matrix";function fe(s){let r=0,e=s.length,t=s[e-1];for(let o of s)r+=(o[0]-t[0])*(o[1]+t[1]),t=o;return r>=0}import{vec2 as ee}from"gl-matrix";function rr(s,r,e){return(r[0]-s[0])*(r[1]+s[1])+(e[0]-r[0])*(e[1]+r[1])+(s[0]-e[0])*(s[1]+e[1])>=0}function Qe(s){let r=Array.from({length:s.length},(e,t)=>t);return r.sort((e,t)=>{let o=s[e],n=s[t];return o[0]<n[0]?-1:o[0]>n[0]?1:o[1]<n[1]?-1:o[1]>n[1]?1:0}),r}function or(s,r,e,t,o,n){return s[r++]=t,rr(t,o,n)===e?(s[r++]=o,s[r++]=n):(s[r++]=n,s[r++]=o),r}function We(s,r,e=0,t){let o=s.length;if(o<3)throw new Error(`Expected input polyline with 3 or more vertices, got ${o}`);let n=e+(o-2)*3;if(r?r.length<n&&(r.length=n):r=new Array(n),o===3)return r[e++]=ee.clone(s[0]),r[e++]=ee.clone(s[1]),r[e++]=ee.clone(s[2]),[r,e];t===void 0&&(t=fe(s));let a=Qe(s),i=[a[0],a[1]];for(let u=2;u<o-1;u++){let m=a[u],f=s[m],h=i.length,y=i[h-1],b=s[y];if(m!==(y+1)%o&&y!==(m+1)%o){for(let d=0;d<h-1;d++)e=or(r,e,t,f,ee.clone(s[i[d]]),ee.clone(s[i[d+1]]));i=[a[u-1],m]}else{let d=b,v=i.pop();for(;i.length>0;){let C=i[i.length-1],V=s[C],N=((C-1)%o+o)%o,M=s[N],A=ee.sub(Sr,V,M),I=ee.fromValues(-A[1],A[0]),T=ee.sub(Ar,f,M);if(ee.dot(T,I)<=0)break;i.pop(),e=or(r,e,t,f,ee.clone(d),ee.clone(V)),v=C,d=V}v!==void 0&&i.push(v),i.push(m)}}let c=s[a[o-1]],l=i.length-1;for(let u=0;u<l;u++)e=or(r,e,t,ee.clone(c),ee.clone(s[i[u]]),ee.clone(s[i[u+1]]));return[r,e]}function Jr(s,r,e){let t=s.length,o=[r];for(let n=(s.indexOf(r)+1)%t;;n=(n+1)%t){let a=s[n];if(o.push(a),a===e)return o;if(a===r)throw new Error(`getPolygonInLoop aborted; infinite loop detected due to possibly invalid split diagonal (${r}, ${e})`)}}function nr(s,r,e,t,o){if(e.length>0){let[n,a]=e[0],i=Jr(r,n,a),c=Jr(r,a,n),l=new Array,u=new Array,m=e.length;for(let f=1;f<m;f++){let[h,y]=e[f];if(i.indexOf(h)>=0&&i.indexOf(y)>=0)l.push([h,y]);else if(c.indexOf(h)>=0&&c.indexOf(y)>=0)u.push([h,y]);else throw new Error(`Invalid split diagonal (${h}, ${y})`)}nr(s,i,l,t,o),nr(s,c,u,t,o)}else{let n=r.length,a=new Array(n);if(o)for(let i=0;i<n;i++)a[i]=s[r[n-1-i]];else for(let i=0;i<n;i++)a[i]=s[r[i]];t.push(a)}}function dt(s,r,e,t=!1){return e||(e=[]),nr(s,Array.from({length:s.length},(o,n)=>n),r,e,t),e}function zr(s,r){return s[0]<r[0]||s[0]===r[0]&&s[1]<r[1]}function $r(s,r,e){let t=-Math.atan2(s[1]-r[1],s[0]-r[0]);return((-Math.atan2(e[1]-r[1],e[0]-r[0])-t)%Q+Q)%Q}function sr(s,r,e,t){let o=-1,n=-1/0;for(let a of r){let i=(a+1)%e,c=s[a],l=s[i],u,m;if(c[0]>l[0]?(u=l,m=c):(m=l,u=c),t[0]>=u[0]&&t[0]<=m[0]){let f=(m[1]-u[1])/(m[0]-u[0]),h=u[1]-f*u[0],y=f*t[0]+h;y<=t[1]&&y>=n&&(n=y,o=a)}}if(o===-1)throw new Error(`No edge to the left of vertex. Status: ${Array.from(r)}`);return o}function Je(s,r,e){e===void 0&&(e=fe(s)),e&&(s=s.slice().reverse());let t=s.length,o=new Map,n=new Set,a=new Map,i=new Array;for(let c of Qe(s)){let l=(c-1%t+t)%t,u=(c+1)%t,m=s[l],f=s[c],h=s[u],y=zr(f,m),b=zr(f,h);if(y&&b){if($r(m,f,h)<Math.PI)a.set(c,0);else{a.set(c,3);let d=sr(s,n,t,f);i.push([c,o.get(d)]),o.set(d,c)}n.add(c),o.set(c,c);continue}else if(!y&&!b){let d=o.get(l);if(d!==void 0&&a.get(d)===4&&i.push([c,d]),n.delete(l),$r(m,f,h)<Math.PI)a.set(c,1);else{a.set(c,4);let v=sr(s,n,t,f),C=o.get(v);C!==void 0&&a.get(C)===4&&i.push([c,C]),o.set(v,c)}continue}if(a.set(c,2),h[0]>f[0]){let d=o.get(l);d!==void 0&&a.get(d)===4&&i.push([c,d]),n.delete(l),n.add(c),o.set(c,c)}else{let d=sr(s,n,t,f),v=o.get(d);v!==void 0&&a.get(v)===4&&i.push([c,v]),o.set(d,c)}}return dt(s,i,r,e)}function Lr(s,r,e=!0){let t=fe(s),o=s.length,n=new E;for(let a=0;a<o;a++){let i=(a+1)%o,c=s[a],l=s[i],u=B.create();yt.copy(u,c);let m=B.fromValues(0,0,r);yt.copy(m,c);let f=B.create();yt.copy(f,l);let h=B.fromValues(0,0,r);yt.copy(h,l);let y=W.calculateNormal(u,f,h),b=new D([new g(B.clone(u),B.clone(y)),new g(f,B.clone(y)),new g(B.clone(h),B.clone(y))]);b.originalValid=!0,n.addPolygon(b);let d=new D([new g(h,B.clone(y)),new g(m,B.clone(y)),new g(u,y)]);d.originalValid=!0,n.addPolygon(d)}if(e){let a=fe(s),i=Je(s,void 0,a);for(let c of i){let[l,u]=We(c,void 0,0,a),m=l.length,f=B.fromValues(0,0,-1),h=B.fromValues(0,0,1);t&&([f,h]=[h,f]);for(let y=0;y<m;){let b=l[y++],d=new g(B.fromValues(b[0],b[1],0),B.clone(f)),v=new g(B.fromValues(b[0],b[1],r),B.clone(h)),C=l[y++],V=new g(B.fromValues(C[0],C[1],0),B.clone(f)),N=new g(B.fromValues(C[0],C[1],r),B.clone(h)),M=l[y++],A=new g(B.fromValues(M[0],M[1],0),B.clone(f)),I=new g(B.fromValues(M[0],M[1],r),B.clone(h)),T=new D([A,V,d]);T.originalValid=!0,n.addPolygon(T);let L=new D([v,N,I]);L.originalValid=!0,n.addPolygon(L)}}}return n}function bt(s,r){let e=fe(s),t=Je(s,void 0,e),o=0;for(let a of t)o+=(a.length-2)*3;r?r.length<o&&(r.length=o):r=new Array(o);let n=0;for(let a of t)[r,n]=We(a,r,n,e);return r}import{mat3 as gt,mat4 as ar,vec2 as vt,vec3 as R}from"gl-matrix";function Hr(s,r,e,t,o,n,a){ar.set(r,n[0],n[1],n[2],0,o[0],o[1],o[2],0,a[0],a[1],a[2],0,t[0],t[1],t[2],1);let i=e.length;for(let c=0;c<i;c++){let l=s[c];vt.copy(l,e[c]),l[2]=0,R.transformMat4(l,l,r)}}function Yr(s,r,e,t,o){for(let n=0;n<t;){let a=R.create();vt.copy(a,r[n++]),R.transformMat4(a,a,e);let i=R.create();vt.copy(i,r[n++]),R.transformMat4(i,i,e);let c=R.create();vt.copy(c,r[n++]),R.transformMat4(c,c,e),o&&([a,c]=[c,a]);let l=W.calculateNormal(a,i,c),u=new g(a,R.clone(l)),m=new g(i,R.clone(l)),f=new g(c,l),h=new D([u,m,f]);h.originalValid=!0,s.addPolygon(h)}}function ir(s,r,e,t){var N,M;let o=r.length;if(e.length!==o)throw new Error("There must be at least one frame per point");if(o<2)throw new Error("There must be at least 1 segment (2 points) in the curve");let n=new E,a=s.length,i=new Array(a),c=new Array(a);for(let A=0;A<a;A++)i[A]=R.create(),c[A]=R.create();let l=ar.create(),u=gt.create(),m=ar.create(),f=gt.create();Hr(c,m,s,r[0],...e[0]),gt.fromMat4(f,m);let h=new Array(a);R.set(O,0,0,1);for(let A=0;A<a;A++){let I=(A+1)%a,T=s[A],L=s[I],Z=R.fromValues(T[0]-L[0],T[1]-L[1],0);h[A]=R.cross(Z,O,Z)}let y=(N=t==null?void 0:t.smoothNormals)!=null?N:!1,b;if(y){b=new Array(a);for(let A=0;A<a;A++){let I=A-1;I===-1&&(I=a-1);let T=R.add(R.create(),h[I],h[A]);b[A]=R.normalize(T,T)}}let d,v,C=(M=t==null?void 0:t.includeBases)!=null?M:!0;C&&(d=bt(s),v=d.length,Yr(n,d,m,v,!1));let V=o-1;for(let A=1;A<o;A++){[i,c,l,m,u,f]=[c,i,m,l,f,u],Hr(c,m,s,r[A],...e[A]),gt.fromMat4(f,m);for(let I=0;I<a;I++){let T=(I+1)%a,L,Z,ie,ge;if(b){let ve=b[I],mr=b[T];L=R.clone(ve),Z=R.clone(mr),ie=R.clone(ve),ge=R.clone(mr)}else{let ve=h[I];L=R.clone(ve),Z=R.clone(ve),ie=R.clone(ve),ge=R.clone(ve)}R.transformMat3(L,L,u),R.transformMat3(Z,Z,u),R.transformMat3(ie,ie,f),R.transformMat3(ge,ge,f);let cr=new g(i[I],L),eo=new g(i[T],Z),to=new g(R.clone(c[I]),ie),lr=new g(R.clone(c[T]),ge),ur=new D([lr.clone(),eo,cr.clone()]);ur.originalValid=!0,n.addPolygon(ur);let fr=new D([cr,to,lr]);fr.originalValid=!0,n.addPolygon(fr)}C&&A===V&&Yr(n,d,m,v,!0)}return n}import{quat as Ao,vec3 as U}from"gl-matrix";function Oo(s,r,e,t,o){var m;let n=r.length;if(e.length<n)throw new Error("There must be at least one tangent per point");if(n<2)throw new Error("There must be at least 1 segment (2 points) in the curve");let a=new Array(n),i=e[0],c=U.cross(U.create(),i,t);a[0]=[t,c,i];for(let f=0;f<n-1;f++){let h=U.sub(O,r[f+1],r[f]),y=U.dot(h,h),b=a[f][0],d=a[f][2],v=-2/y,C=U.scaleAndAdd($,b,h,U.dot(h,b)*v),V=U.scaleAndAdd(Vt,d,h,U.dot(h,d)*v),N=e[f+1],M=U.sub(Vt,N,V),A=U.dot(M,M),I=U.scaleAndAdd(U.create(),C,M,U.dot(M,C)*-2/A),T=U.cross(U.create(),N,I);a[f+1]=[I,T,N]}let l=o==null?void 0:o.endNormal,u=(m=o==null?void 0:o.twists)!=null?m:0;if(l||u>0){let f=0;if(l){let h=e[n-1],y=U.cross(U.create(),h,l),b=a[n-1][0],d=U.dot(y,b),v=U.dot(l,b);d!==0&&v!==0&&(f=Math.atan2(v,d)-dr)}if(f+=Q*u,f!==0){let h=0,y=r[0];for(let d=1;d<n;d++){let v=r[d];h+=U.distance(y,v),y=v}let b=0;y=r[0];for(let d=1;d<n;d++){let[v,C,V]=a[d],N=r[d];b+=U.distance(y,N),y=N;let M=f*b/h;Ao.setAxisAngle(rt,e[d],M),U.transformQuat(v,v,rt),U.transformQuat(C,C,rt)}}}return ir(s,r,a,o)}import{vec2 as Go}from"gl-matrix";function xt(s,r,e=!1){if(r<3)throw new Error("There must be at least 3 sides in a regular polyline");let t=new Array(r),o=r-1;for(let n=0;n<r;n++){let a=e?n:o-n,i=Q*a/r,c=Math.cos(i)*s,l=Math.sin(i)*s;t[n]=Go.fromValues(l,c)}return t}function Xr(s,r=!1,e=12){return xt(s,e,r)}import{vec2 as ye}from"gl-matrix";function Kr(s,r=!1){let e=s/2;return r?[ye.fromValues(e,e),ye.fromValues(e,-e),ye.fromValues(-e,-e),ye.fromValues(-e,e)]:[ye.fromValues(e,e),ye.fromValues(-e,e),ye.fromValues(-e,-e),ye.fromValues(e,-e)]}import{vec2 as be}from"gl-matrix";function Zr(s,r,e=!1){let t=s/2,o=r/2;return e?[be.fromValues(t,o),be.fromValues(t,-o),be.fromValues(-t,-o),be.fromValues(-t,o)]:[be.fromValues(t,o),be.fromValues(-t,o),be.fromValues(-t,-o),be.fromValues(t,-o)]}import{vec2 as Qr}from"gl-matrix";function qr(s,r,e,t=!1){if(e<3)throw new Error("There must be at least 3 sides in a star polyline");let o=new Array(e*2),n=e-1,a=Q/e/2,i=0;for(let c=0;c<e;c++){let l=t?c:n-c,u=Q*l/e,m=Math.cos(u)*s,f=Math.sin(u)*s,h=Qr.fromValues(f,m),y=u+a,b=Math.cos(y)*r,d=Math.sin(y)*r,v=Qr.fromValues(d,b);t?(o[i++]=h,o[i++]=v):(o[i++]=v,o[i++]=h)}return o}export{H as CSGPrimitive,Kt as Cone,$t as Cube,Ve as CubeSphere,Ye as Cuboid,Xt as Cylinder,Qt as Icosahedron,qt as Icosphere,te as JobError,hr as JobFailReason,E as OctreeCSG,Be as OctreeCSGJobDispatcher,W as Plane,D as Polygon,Zt as Pyramid,Lt as Sphere,tr as Torus,Ht as UVSphere,g as Vertex,ir as curveExtrude,fe as isClockwise2DPolygon,Lr as linearExtrude,Xr as makeCirclePolyline,Kr as makeCubePolyline,Zr as makeRectanglePolyline,xt as makeRegularPolyline,qr as makeStarPolyline,Je as partition2DPolygon,Oo as rotationMinimizingCurveExtrude,dt as split2DPolygon,bt as triangulate2DPolygon,pt as triangulateConvexPolygon,We as triangulateMonotone2DPolygon};
//# sourceMappingURL=OctreeCSG-ea.esm.min.js.map
